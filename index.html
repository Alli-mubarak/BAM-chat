<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAMchat</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <section class="container">
        <section class="username-page">
            <h2>BAMchat</h2>
            <h5>by BAM-TECH</h5>
            <div class="username-input">
                <form class="label-input">
                <label for="username-input">Enter your username to join the chat</label><br>
                <input type="text" name="username" id="username-input">
                <button type="submit" onclick="enterUsername(this)">Enter</button>
                </form>
                <p id="report"></p>
            </div>
            <div class="loader"></div>
        </section>
    
      <section class="chat-page">
        <div class="message-area">
            <p class="interaction">You are interacting as <span id="username">user</span></p>
            <p class="label">conversations will appear here</p>
            <div class="menu">
                <span></span><span></span><span></span>
            </div>
            <form class="ip-change">
                <label for="ip=input">change IP Address</label><br>
                <input type="tel" maxlength="15" name="ip-input" id="ip-input" placeholder="enter address"><br><br>
                <button type="submit" onclick="ipChange()">Change</button>
            </form>
            <div class="messages"></div>
            <p class="result"></p>
        </div>
        
        <div class="input-area">
            <textarea name="message" id="message" placeholder="Type message here ......"></textarea>
            <div class="send" onclick="sendMessage()">&#x27A2;</div>
            <div class="go-down" onclick="goDown()">&#x2794;</div>
        </div>
      </section>
    </section>
<script>
    // myIp = '192.168.95.199'
   let  myIp;
const report = document.getElementById("report");
const usernamePage  = document.querySelector(".username-page");
const usernameInputBox  = document.querySelector(".username-input");
const username = document.getElementById("username");
const loader = document.querySelector(".loader");
const messageBox = document.querySelector(".messages");
let messagesLength;
let noOfMessages = 0;
const inputter = document.querySelector("#message");
const result = document.querySelector(".result");
let cssSheet = document.querySelector("style").sheet;
const usernameForm = document.querySelector(".label-input");
const ipInput = document.getElementById("ip-input")
const ipForm = document.querySelector(".ip-change");
const menu = document.querySelector(".menu");
let senderName = 'mubarak';
    const usernameInput = document.getElementById("username-input");
    function enterUsername(me){
        
        if(usernameInput.value.length > 3){
        let myCss = `
        .${usernameInput.value}{
            margin-left: auto;
            border-color: lightblue;
            border-radius: 30px 30px 0 30px ;
            border:1px solid lightblue;
            margin-right: 20px;
        }`;
        let myNameCss = `
        .${usernameInput.value} .sender{
        display:none;
        }`
        let othersCss = `
        .messages div:not(.${usernameInput.value}){
            border-color: lightgreen;
            border-radius: 30px 30px 30px 0;
            border:1px solid lightgreen;
            margin-left: 20px;
        }`
        let othersNameCss = `
        .messages div:not(.${usernameInput.value}) .sender{
            color: green;
        }`
        
            senderName = usernameInput.value;
            username.innerHTML = senderName;
            cssSheet.insertRule(myCss,0);
            cssSheet.insertRule(myNameCss,1);
            cssSheet.insertRule(othersCss,2);
            cssSheet.insertRule(othersNameCss,3);
            usernameInputBox.style.display = 'none';
            loader.style.display = "block";
            me.setAttribute("disabled","true");
            setTimeout(() => {
                usernamePage.style.display = "none";
                loader.style.display = 'none';
            }, 5000);
            

            setTimeout(() => {
                usernameInput.value = '';
            }, 1000);
        }
        else{
            report.innerHTML = "Enter a valid username!"
            setTimeout(() => {
                report.innerHTML ='';
            }, 1000);
        }
    }
    usernameForm.addEventListener("submit", (e) =>{
    e.preventDefault();
    enterUsername();
})
function seekMessages(){
let messageID = setInterval(() => {
    loadMessages();
}, 600);
function loadMessages(){
    fetch(`http://${myIp}:1800/messages`)
    .then(res=> res.text())
    .then(data =>(
        messageBox.innerHTML = data
    ))
    .catch(error =>{
        clearInterval(messageID);
        messageBox.innerHTML=`<p class="err">Unable to connect to server, reload page!</p>`;
    })
}
loadMessages();
}
seekMessages()
function sendMessage(){
    setTimeout(() => {
        result.innerHTML = '';
        inputter.value = '';
        goDown();
    }, 1000);
    if (inputter.value.length > 1){
     let message = {"content":inputter.value, "sender":senderName}
     fetch(`http://${myIp}:1800/messages`,{
            method:'POST',
        headers:{
        'Content-type':'application/json'
        },
        body:JSON.stringify(message)
        })
        .catch(error =>{
            result.innerHTML = "Unable to connect to server, try again!";
        })
}
}
function ipChange(){
let ip = ipInput.value
let octet1 = ip.slice(0, 3)
let octet2 = ip.slice(3, 6)
let octet3 = ip.slice(6,8)
let octet4 = ip.slice(8)
sortedIP = `${octet1}.${octet2}.${octet3}.${octet4}`
myIp = ip;
    console.log("IP Address updated: " + myIp);
    seekMessages();
    setTimeout(()=>{
        ipInput.value = '';
    },500)
}

    ipForm.addEventListener("submit", (e) =>{
    e.preventDefault();
    ipChange();
})

menu.onclick = () =>{
    ipForm.classList.toggle('active');
}
function goDown(){
    messageBox.scrollTo(0, messageBox.scrollHeight);
}
</script>
</body>
</html>
